<!DOCTYPE html>
<html xmlns:th="http://www.thymeleaf.org" lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Operations Manager Dashboard - Sri Lanka Railways</title>


    <link href="/css/driver_dashboard.css" rel="stylesheet">
</head>
<body>
<div class="container-fluid">
    <!-- Manager Header -->
    <div class="row">
        <div class="col-12">
            <div class="card">
                <div class="card-header">
                    <div class="header-content">
                        <div>
                            <h4>
                                <i class="fas fa-cog"></i>Operations Manager Dashboard
                            </h4>
                            <small>Station Operations Control Center</small>
                        </div>
                        <div class="header-info">
                            <div>Station Manager Portal</div>
                            <div>Real-time Operations</div>
                            <span class="badge status-on-duty">Active</span>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <!-- Main Content Row -->
    <div class="row">
        <!-- Left Column - Train Status & Control -->
        <div class="col-lg-6">
            <!-- Train Status Updates Card -->
            <div class="card">
                <div class="card-header">
                    <h5><i class="fas fa-broadcast-tower"></i>Send Train Status Updates</h5>
                </div>
                <div class="card-body">
                    <!-- Success/Error Messages -->
                    <div th:if="${successMessage}" class="alert alert-success alert-dismissible">
                        <i class="fas fa-check-circle"></i>
                        <span th:text="${successMessage}"></span>
                        <button type="button" class="btn-close" data-bs-dismiss="alert"></button>
                    </div>

                    <div th:if="${errorMessage}" class="alert alert-danger alert-dismissible">
                        <i class="fas fa-exclamation-circle"></i>
                        <span th:text="${errorMessage}"></span>
                        <button type="button" class="btn-close" data-bs-dismiss="alert"></button>
                    </div>

                    <form th:action="@{/manager/updateStatus}" method="post" class="update-form">
                        <div class="row">
                            <div class="col-md-6">
                                <label>Train</label>
                                <select class="form-select" name="trainId" required>
                                    <option value="">Select train</option>
                                    <option th:each="t : ${trainList}" th:value="${t.id}" th:text="${t.code + ' â€” ' + t.route}"></option>
                                </select>
                            </div>
                            <div class="col-md-6">
                                <label>Status</label>
                                <select id="statusSelect" class="form-select" name="status" required>
                                    <option value="">Select status</option>
                                    <option>On Time</option>
                                    <option>Delayed</option>
                                    <option>Cancelled</option>
                                    <option>Platform Change</option>
                                </select>
                            </div>
                        </div>
                        <div id="platformWrap" class="platform-change-section" style="display:none;">
                            <label>New platform</label>
                            <input type="text" class="form-control" name="platformNo" placeholder="e.g., 3">
                        </div>
                        <button type="submit" class="btn btn-send-update">
                            <i class="fas fa-bullhorn"></i>Broadcast Update
                        </button>
                    </form>
                </div>
            </div>

            <!-- Route Management Card -->
            <div class="card">
                <div class="card-header">
                    <h5><i class="fas fa-route"></i>Train Route Management</h5>
                </div>
                <div class="card-body">
                    <!-- Add New Route Form -->
                    <div class="route-form-section">
                        <button class="btn btn-arrival" type="button"
                                data-bs-toggle="collapse" data-bs-target="#addRouteForm">
                            <i class="fas fa-plus"></i>Add New Route
                        </button>

                        <div class="collapse" id="addRouteForm">
                            <form th:action="@{/manager/route/create}" method="post" class="delay-form">
                                <div class="row">
                                    <div class="col-md-6">
                                        <label>Train</label>
                                        <select class="form-select" name="trainId" required>
                                            <option value="">Select train</option>
                                            <option th:each="t : ${trainList}" th:value="${t.id}" th:text="${t.code}"></option>
                                        </select>
                                    </div>
                                    <div class="col-md-6">
                                        <label>Platform</label>
                                        <input type="text" class="form-control" name="platformNo" placeholder="e.g., 3">
                                    </div>
                                </div>
                                <div>
                                    <label>Scheduled Stops</label>
                                    <input type="text" class="form-control" name="stops" placeholder="Comma separated stops" required>
                                </div>
                                <div>
                                    <label>Instructions for Driver</label>
                                    <textarea name="instructions" class="form-control" rows="2" placeholder="Any notes for driver"></textarea>
                                </div>
                                <button type="submit" class="btn btn-submit-delay">Add Route</button>
                            </form>
                        </div>
                    </div>

                    <!-- Current Routes -->
                    <div class="routes-list">
                        <h6>Current Routes</h6>
                        <div class="stops-container">
                            <div th:each="r : ${routeList}" class="stop-item">
                                <div class="stop-content">
                                    <div>
                                        <strong th:text="${r.trainCode}">T-101</strong>
                                        <div class="stop-times">
                                            <span th:text="'Stops: ' + ${r.stops}"></span>
                                            <span th:text="' | Platform: ' + ${r.platformNo}"></span>
                                        </div>
                                        <div class="small text-muted" th:text="${r.instructions}" th:if="${r.instructions}"></div>
                                    </div>
                                    <div class="route-actions">
                                        <button class="btn btn-sm btn-delay"
                                                data-bs-toggle="collapse"
                                                th:attr="data-bs-target='#editRoute' + ${r.id}">
                                            <i class="fas fa-edit"></i>
                                        </button>
                                        <form th:action="@{|/manager/route/${r.id}/delete|}" method="post" class="d-inline"
                                              onsubmit="return confirm('Delete this route?')">
                                            <input type="hidden" th:name="${_csrf.parameterName}" th:value="${_csrf.token}">
                                            <button type="submit" class="btn btn-sm btn-emergency">
                                                <i class="fas fa-trash"></i>
                                            </button>
                                        </form>
                                    </div>
                                </div>

                                <!-- Edit Route Form (Collapsed) -->
                                <div class="collapse" th:id="'editRoute' + ${r.id}">
                                    <form th:action="@{|/manager/route/${r.id}/update|}" method="post" class="issue-form">
                                        <input type="hidden" th:name="${_csrf.parameterName}" th:value="${_csrf.token}">
                                        <div class="row">
                                            <div class="col-md-6">
                                                <label>Scheduled Stops</label>
                                                <input type="text" class="form-control" name="stops" th:value="${r.stops}">
                                            </div>
                                            <div class="col-md-6">
                                                <label>Platform</label>
                                                <input type="text" class="form-control" name="platformNo" th:value="${r.platformNo}">
                                            </div>
                                        </div>
                                        <div>
                                            <label>Instructions</label>
                                            <textarea name="instructions" class="form-control" rows="2" th:text="${r.instructions}"></textarea>
                                        </div>
                                        <button type="submit" class="btn btn-submit-issue">Save Changes</button>
                                    </form>
                                </div>
                            </div>

                            <div th:if="${#lists.isEmpty(routeList)}" class="no-communications">
                                No route information available
                            </div>
                        </div>
                    </div>
                </div>
            </div>
        </div>

        <!-- Right Column - Train Tracking & Messages -->
        <div class="col-lg-6">
            <!-- Train Arrivals/Departures Card -->
            <div class="card">
                <div class="card-header">
                    <h5><i class="fas fa-train"></i>Train Arrivals & Departures</h5>
                </div>
                <div class="card-body">
                    <div class="stops-container">
                        <div th:each="t : ${trainList}" class="stop-item"
                             th:classappend="${t.status == 'On Time'} ? 'completed' : (${t.status == 'Delayed'} ? 'current' : '')">
                            <div class="stop-content">
                                <div>
                                    <strong th:text="${t.code}">T-101</strong>
                                    <div class="stop-times">
                                        <span th:text="'Route: ' + ${t.route}"></span>
                                    </div>
                                    <div class="stop-times">
                                        <span th:text="'Arr: ' + ${#temporals.format(t.arrivalTime,'HH:mm')}"></span>
                                        <span th:text="' | Dep: ' + ${#temporals.format(t.departureTime,'HH:mm')}"></span>
                                        <span th:text="' | Platform: ' + ${t.platform ?: '-'}"></span>
                                    </div>
                                </div>
                                <div>
                                    <span class="badge status-departed" th:if="${t.status == 'On Time'}">ON TIME</span>
                                    <span class="badge status-current" th:if="${t.status == 'Delayed'}">DELAYED</span>
                                    <span class="badge status-upcoming" th:if="${t.status == 'Cancelled'}">CANCELLED</span>
                                    <span class="badge status-on-duty" th:if="${t.status != 'On Time' && t.status != 'Delayed' && t.status != 'Cancelled'}" th:text="${t.status}"></span>
                                </div>
                            </div>
                        </div>

                        <div th:if="${#lists.isEmpty(trainList)}" class="no-communications">
                            No trains scheduled
                        </div>
                    </div>
                </div>
            </div>

            <!-- Driver Messages Card -->
            <div class="card">
                <div class="card-header">
                    <h5><i class="fas fa-comments"></i>Messages from Train Drivers</h5>
                </div>
                <div class="card-body">
                    <div class="communications-container">
                        <div th:if="${driverMessages != null and !driverMessages.isEmpty()}">
                            <div th:each="msg : ${driverMessages}" class="communication-item"
                                 th:classappend="${msg.severity == 'High'} ? 'alert-danger' : (${msg.severity == 'Medium'} ? 'alert-warning' : 'alert-info')">
                                <div class="communication-header">
                                    <div>
                                        <strong th:text="${msg.trainCode + ' - ' + msg.driverName}">T-101 - A. Perera</strong>
                                        <span class="badge"
                                              th:classappend="${msg.severity == 'High'} ? 'status-upcoming' : (${msg.severity == 'Medium'} ? 'status-current' : 'status-departed')"
                                              th:text="${msg.severity}">Medium</span>
                                    </div>
                                    <small th:text="${#temporals.format(msg.timestamp,'HH:mm')}">14:42</small>
                                </div>
                                <div th:text="${msg.content}">Delay due to signal issue near Gampaha</div>
                            </div>
                        </div>
                        <div th:if="${driverMessages == null or driverMessages.isEmpty()}" class="no-communications">
                            No messages received from drivers
                        </div>
                    </div>
                </div>
            </div>

            <!-- Quick Actions Card -->
            <div class="card">
                <div class="card-header">
                    <h5><i class="fas fa-tools"></i>Quick Actions</h5>
                </div>
                <div class="card-body">
                    <div class="row quick-actions">
                        <div class="col-md-6">
                            <button class="btn btn-arrival" onclick="window.location.reload()">
                                <i class="fas fa-sync"></i>Refresh Data
                            </button>
                        </div>
                        <div class="col-md-6">
                            <button class="btn btn-departure" data-bs-toggle="collapse" data-bs-target="#announcementForm">
                                <i class="fas fa-bullhorn"></i>Make Announcement
                            </button>
                        </div>
                    </div>

                    <!-- Announcement Form -->
                    <div class="collapse" id="announcementForm">
                        <form class="delay-form" action="#" method="post">
                            <div>
                                <label>Announcement Type</label>
                                <select class="form-select" name="announcementType" required>
                                    <option value="">Select type...</option>
                                    <option value="delay">Delay Notification</option>
                                    <option value="platform">Platform Change</option>
                                    <option value="general">General Announcement</option>
                                    <option value="emergency">Emergency Notice</option>
                                </select>
                            </div>
                            <div>
                                <label>Message</label>
                                <textarea name="message" class="form-control" rows="3" required
                                          placeholder="Enter announcement message..."></textarea>
                            </div>
                            <button type="submit" class="btn btn-send-update">
                                <i class="fas fa-broadcast-tower"></i>Send Announcement
                            </button>
                        </form>
                    </div>

                    <!-- Emergency Actions -->
                    <div class="emergency-section">
                        <h6 class="emergency-title"><i class="fas fa-exclamation-triangle"></i>Emergency Controls</h6>
                        <p class="emergency-warning">Use only in genuine emergency situations</p>

                        <button class="btn btn-emergency" type="button"
                                onclick="return confirm('Are you sure you want to initiate emergency protocols?')">
                            <i class="fas fa-exclamation-triangle"></i>Emergency Stop All Trains
                        </button>
                    </div>
                </div>
            </div>
        </div>
    </div>
</div>

<script>
    // Show platform field when "Platform Change" is chosen
    const statusSelect = document.getElementById('statusSelect');
    const platformWrap = document.getElementById('platformWrap');
    if (statusSelect) {
        statusSelect.addEventListener('change', function () {
            platformWrap.style.display = this.value === 'Platform Change' ? 'block' : 'none';
        });
    }

    // Auto-dismiss alerts after 5 seconds
    document.addEventListener('DOMContentLoaded', function() {
        setTimeout(function() {
            var alerts = document.querySelectorAll('.alert-dismissible');
            alerts.forEach(function(alert) {
                var closeButton = alert.querySelector('.btn-close');
                if (closeButton) {
                    closeButton.click();
                }
            });
        }, 5000);
    });

    // Auto-refresh page every 30 seconds to get updates
    setTimeout(function() {
        window.location.reload();
    }, 30000);

    // Add some custom styling for route actions
    const style = document.createElement('style');
    style.textContent = `
            .route-actions {
                display: flex;
                gap: 5px;
                align-items: center;
            }

            .route-actions .btn {
                min-height: 32px;
                padding: 6px 12px;
                font-size: 0.8rem;
            }

            .platform-change-section {
                margin-top: 15px;
                padding: 15px;
                background: linear-gradient(45deg, #fff3cd, #ffeaa7);
                border-radius: 8px;
                border-left: 4px solid #ffc107;
            }

            .route-form-section {
                margin-bottom: 25px;
            }

            .routes-list h6 {
                margin-bottom: 15px;
                font-weight: 600;
                color: #555;
            }
        `;
    document.head.appendChild(style);
</script>
</body>
</html>